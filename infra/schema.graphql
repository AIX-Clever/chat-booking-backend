
# Scalars
scalar AWSDateTime
scalar AWSJSON

# Enums
enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  NO_SHOW
}

enum PaymentStatus {
  NONE
  PENDING
  PAID
  FAILED
}

type SubscriptionResponse @aws_cognito_user_pools {
  subscriptionId: String!
  initPoint: String!
  message: String
}

type DowngradeResponse @aws_cognito_user_pools {
  message: String!
  effectiveDate: String!
}

enum ConversationState {
  INIT
  SERVICE_PENDING
  SERVICE_SELECTED
  PROVIDER_PENDING
  PROVIDER_SELECTED
  SLOT_PENDING
  CONFIRM_PENDING
  BOOKING_CONFIRMED
}

enum LocationType {
  ONLINE
  PHYSICAL
}

# Types - Tenant
type Room @aws_api_key @aws_cognito_user_pools {
  roomId: ID!
  tenantId: ID!
  name: String!
  description: String
  capacity: Int!
  status: String!
  isVirtual: Boolean
  minDuration: Int
  maxDuration: Int
  operatingHours: AWSJSON
  metadata: AWSJSON
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
}

enum TenantStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
}

enum TenantPlan {
  LITE
  PRO
  BUSINESS
  ENTERPRISE
}

type Tenant @aws_api_key @aws_cognito_user_pools {
  tenantId: ID!
  name: String!
  slug: String!
  status: TenantStatus!
  plan: TenantPlan!
  ownerUserId: String!
  billingEmail: String!
  settings: AWSJSON
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
}

type ApiKey @aws_cognito_user_pools {
  apiKeyId: ID!
  tenantId: ID!
  name: String
  keyPreview: String
  status: String!

  createdAt: AWSDateTime!
  lastUsedAt: AWSDateTime
  apiKey: String # Only populated on creation
}

# User Management Types
type TenantUser @aws_cognito_user_pools {
  userId: ID!
  tenantId: ID!
  email: String!
  name: String
  role: UserRole!
  status: UserStatus!
  createdAt: AWSDateTime!
  lastLogin: AWSDateTime
}

enum UserRole {
  OWNER
  ADMIN
  USER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  PENDING_INVITATION
}

type FAQ @aws_api_key @aws_cognito_user_pools {
  faqId: ID!
  tenantId: ID!
  question: String!
  answer: String!
  category: String!
  active: Boolean!
}

type Conversation @aws_api_key @aws_cognito_user_pools {
  conversationId: ID!
  tenantId: ID!
  state: String!
  context: AWSJSON
  messages: [Message!]
  channel: String
  metadata: AWSJSON
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
}

type Message @aws_api_key @aws_cognito_user_pools {
  role: String!
  content: String!
  timestamp: String!
  metadata: AWSJSON
}

type ChatResponse @aws_api_key @aws_cognito_user_pools {
  conversation: Conversation!
  response: String
}

type Booking @aws_api_key @aws_cognito_user_pools {
  bookingId: ID!
  tenantId: ID!
  serviceId: ID!
  providerId: ID!
  start: AWSDateTime!
  end: AWSDateTime!
  status: BookingStatus!
  paymentStatus: PaymentStatus
  clientName: String
  clientEmail: String
  clientPhone: String
  notes: String
  roomId: ID
  conversationId: ID
  metadata: AWSJSON
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
}

type Workflow @aws_cognito_user_pools {
  workflowId: ID!
  tenantId: ID!
  name: String!
  description: String
  steps: AWSJSON!
  metadata: AWSJSON
  isActive: Boolean!
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
}

# Types - Dashboard Metrics
type DashboardSummary @aws_cognito_user_pools {
  revenue: Float!
  bookings: Int!
  messages: Int!
  tokensIA: Int!
  conversionsChat: Int!
  aiResponses: Int!
  conversionRate: Float!
  autoAttendanceRate: Float!
}

type DailyMetric @aws_cognito_user_pools {
  date: String!
  bookings: Int!
  messages: Int!
}

type TopService @aws_cognito_user_pools {
  serviceId: ID!
  name: String!
  bookings: Int!
}

type TopProvider @aws_cognito_user_pools {
  providerId: ID!
  name: String!
  bookings: Int!
}

type BookingStatusCounts @aws_cognito_user_pools {
  CONFIRMED: Int!
  PENDING: Int!
  CANCELLED: Int!
  NO_SHOW: Int!
}

type MetricError @aws_cognito_user_pools {
  type: String!
  count: Int!
  lastOccurred: String
}

type DashboardMetrics @aws_cognito_user_pools {
  period: String!
  summary: DashboardSummary!
  daily: [DailyMetric!]!
  topServices: [TopService!]!
  topProviders: [TopProvider!]!
  bookingStatus: BookingStatusCounts!
  errors: [MetricError!]!
}

type PlanUsage @aws_cognito_user_pools {
  messages: Int!
  bookings: Int!
  tokensIA: Int!
}

# Billing & Invoices
enum InvoiceStatus {
  PAID
  PENDING
  FAILED
  REFUNDED
}

type Invoice @aws_cognito_user_pools {
  invoiceId: ID!
  tenantId: ID!
  amount: Float!
  currency: String!
  status: InvoiceStatus!
  date: AWSDateTime!
  pdfUrl: String
  metadata: AWSJSON
}

type BillingDetails @aws_cognito_user_pools {
  companyName: String
  rut: String
  address: String
  city: String
}

# Types - Catalog
type Category @aws_api_key @aws_cognito_user_pools {
  categoryId: ID!
  tenantId: ID!
  name: String!
  description: String
  isActive: Boolean!
  displayOrder: Int
  metadata: AWSJSON
  createdAt: AWSDateTime!
  updatedAt: AWSDateTime!
}

type Service @aws_api_key @aws_cognito_user_pools {
  serviceId: ID!
  name: String!
  description: String
  category: String!
  durationMinutes: Int!
  price: Float
  available: Boolean!
  requiredRoomIds: [ID]
  locationType: [LocationType]
}

type Provider @aws_api_key @aws_cognito_user_pools {
  providerId: ID!
  name: String!
  bio: String
  serviceIds: [ID!]!
  timezone: String!
  metadata: AWSJSON
  photoUrl: String
  photoUrlThumbnail: String
  available: Boolean!
}

# Types - Availability
type TimeSlot @aws_api_key @aws_cognito_user_pools {
  providerId: ID!
  serviceId: ID!
  start: AWSDateTime!
  end: AWSDateTime!
  isAvailable: Boolean!
}

type TimeRange @aws_api_key @aws_cognito_user_pools {
  startTime: String!
  endTime: String!
}

type ProviderAvailability @aws_cognito_user_pools {
  providerId: ID!
  dayOfWeek: String!
  timeRanges: [TimeRange!]!
  breaks: [TimeRange!]
  exceptions: [ExceptionRule!]
}

type ExceptionRule @aws_api_key @aws_cognito_user_pools {
  date: String!
  timeRanges: [TimeRange!]!
}

# Inputs - Shared
input TimeRangeInput {
  startTime: String!
  endTime: String!
}

# Inputs - Tenant & Catalog
input RegisterTenantInput {
  email: String!
  password: String!
  companyName: String!
  plan: TenantPlan
}

input UpdateTenantInput {
  name: String
  billingEmail: String
  settings: AWSJSON
}

input CreateCategoryInput {
  name: String!
  description: String
  metadata: AWSJSON
  displayOrder: Int
}

input UpdateCategoryInput {
  categoryId: ID!
  name: String
  description: String
  isActive: Boolean
  displayOrder: Int
  metadata: AWSJSON
}

input CreateServiceInput {
  name: String!
  description: String
  category: String!
  durationMinutes: Int!
  price: Float
  available: Boolean
  requiredRoomIds: [ID]
  locationType: [LocationType]
}

input UpdateServiceInput {
  serviceId: ID!
  name: String
  description: String
  category: String
  durationMinutes: Int
  price: Float
  available: Boolean
  requiredRoomIds: [ID]
  locationType: [LocationType]
}

input CreateProviderInput {
  name: String!
  bio: String
  serviceIds: [ID!]!
  timezone: String!
  metadata: AWSJSON
  photoUrl: String
  photoUrlThumbnail: String
}

input UpdateProviderInput {
  providerId: ID!
  name: String
  bio: String
  serviceIds: [ID!]
  timezone: String
  metadata: AWSJSON
  photoUrl: String
  photoUrlThumbnail: String
  available: Boolean
}

input CreateRoomInput {
  name: String!
  description: String
  capacity: Int!
  status: String
  isVirtual: Boolean
  minDuration: Int
  maxDuration: Int
  operatingHours: AWSJSON
  metadata: AWSJSON
}

input UpdateRoomInput {
  roomId: ID!
  name: String
  description: String
  capacity: Int
  status: String
  isVirtual: Boolean
  minDuration: Int
  maxDuration: Int
  operatingHours: AWSJSON
  metadata: AWSJSON
}

# Inputs - Availability & FAQs
input GetAvailableSlotsInput {
  serviceId: ID!
  providerId: ID!
  from: AWSDateTime!
  to: AWSDateTime!
}

input SetAvailabilityInput {
  providerId: ID!
  dayOfWeek: String!
  timeRanges: [TimeRangeInput!]!
  breaks: [TimeRangeInput!]
}

input CreateFAQInput {
  question: String!
  answer: String!
  category: String!
  active: Boolean
}

input UpdateFAQInput {
  faqId: ID!
  question: String
  answer: String
  category: String
  active: Boolean
}

# Inputs - Bookings
input CreateBookingInput {
  serviceId: ID!
  providerId: ID!
  start: AWSDateTime!
  end: AWSDateTime!
  clientName: String!
  clientEmail: String!
  clientPhone: String
  notes: String
  conversationId: ID
  roomId: ID
}

input ConfirmBookingInput {
  bookingId: ID!
  tenantId: ID
}

input CancelBookingInput {
  bookingId: ID!
  reason: String
  tenantId: ID
}

input GetBookingInput {
  bookingId: ID!
}

input ListBookingsByProviderInput {
  providerId: ID!
  startDate: AWSDateTime!
  endDate: AWSDateTime!
}

input ListBookingsByClientInput {
  clientEmail: String!
}

input GetBookingByConversationInput {
  conversationId: ID!
}

# Inputs - Chat
input StartConversationInput {
  channel: String
  metadata: AWSJSON
}

input SendMessageInput {
  conversationId: ID!
  message: String!
  messageType: String
  userData: AWSJSON
}

input ConfirmBookingFromConversationInput {
  conversationId: ID!
}

input GetConversationInput {
  conversationId: ID!
}

# Inputs - Workflow
input CreateWorkflowInput {
  name: String!
  description: String
  steps: AWSJSON!
  metadata: AWSJSON
  isActive: Boolean
}

input UpdateWorkflowInput {
  workflowId: ID!
  name: String
  description: String
  steps: AWSJSON
  metadata: AWSJSON
  isActive: Boolean
}

# User Management Inputs
input InviteUserInput {
  email: String!
  name: String
  role: UserRole!
}

input UpdateUserRoleInput {
  userId: ID!
  role: UserRole!
}

# Queries
type Query {
  # Catalog
  listCategories(activeOnly: Boolean): [Category!]! @aws_api_key @aws_cognito_user_pools
  searchServices(text: String, availableOnly: Boolean): [Service!]! @aws_api_key @aws_cognito_user_pools
  getService(serviceId: ID!): Service @aws_api_key @aws_cognito_user_pools
  listProviders: [Provider!]! @aws_api_key @aws_cognito_user_pools
  listProvidersByService(serviceId: ID!): [Provider!]! @aws_api_key @aws_cognito_user_pools

  listRooms: [Room!]! @aws_cognito_user_pools
  getRoom(roomId: ID!): Room @aws_cognito_user_pools
  
  # Availability
  getAvailableSlots(input: GetAvailableSlotsInput!): [TimeSlot!]! @aws_api_key @aws_cognito_user_pools
  getProviderAvailability(providerId: ID!): [ProviderAvailability!]! @aws_cognito_user_pools
  
  # Bookings
  getBooking(input: GetBookingInput!): Booking @aws_api_key @aws_cognito_user_pools
  listBookingsByProvider(input: ListBookingsByProviderInput!): [Booking!]! @aws_cognito_user_pools
  listBookingsByClient(input: ListBookingsByClientInput!): [Booking!]! @aws_cognito_user_pools
  getBookingByConversation(input: GetBookingByConversationInput!): Booking @aws_api_key @aws_cognito_user_pools
  
  # Chat
  getConversation(input: GetConversationInput!): Conversation @aws_api_key @aws_cognito_user_pools
  getTenant(tenantId: ID): Tenant @aws_api_key @aws_cognito_user_pools
  listFAQs: [FAQ!]! @aws_api_key @aws_cognito_user_pools
  
  # Workflow (Admin)
  listWorkflows: [Workflow!]! @aws_cognito_user_pools
  getWorkflow(workflowId: ID!): Workflow @aws_cognito_user_pools

  # Dashboard Metrics (Admin)
  getDashboardMetrics: DashboardMetrics @aws_cognito_user_pools
  getPlanUsage: PlanUsage @aws_cognito_user_pools

  # User Management (Admin)
  listTenantUsers: [TenantUser!]! @aws_cognito_user_pools
  getTenantUser(userId: ID!): TenantUser @aws_cognito_user_pools

  # API Keys (Admin)
  listApiKeys: [ApiKey!]! @aws_cognito_user_pools

  # Billing (Admin)
  listInvoices: [Invoice!]! @aws_cognito_user_pools
}

# Mutations
type Mutation {
  # Tenant (Public/Auth)
  registerTenant(input: RegisterTenantInput!): Tenant @aws_api_key
  updateTenant(input: UpdateTenantInput!): Tenant! @aws_cognito_user_pools

  # Catalog (Admin)
  createCategory(input: CreateCategoryInput!): Category! @aws_cognito_user_pools
  updateCategory(input: UpdateCategoryInput!): Category! @aws_cognito_user_pools
  deleteCategory(categoryId: ID!): Category! @aws_cognito_user_pools

  generatePresignedUrl(fileName: String!, contentType: String!): String! @aws_cognito_user_pools

  createService(input: CreateServiceInput!): Service! @aws_cognito_user_pools
  updateService(input: UpdateServiceInput!): Service! @aws_cognito_user_pools
  deleteService(serviceId: ID!): Service! @aws_cognito_user_pools
  
  createProvider(input: CreateProviderInput!): Provider! @aws_cognito_user_pools
  updateProvider(input: UpdateProviderInput!): Provider! @aws_cognito_user_pools
  deleteProvider(providerId: ID!): Provider! @aws_cognito_user_pools

  createRoom(input: CreateRoomInput!): Room! @aws_cognito_user_pools
  updateRoom(input: UpdateRoomInput!): Room! @aws_cognito_user_pools
  deleteRoom(roomId: ID!): Room! @aws_cognito_user_pools
  
  # Availability (Admin)
  setProviderAvailability(input: SetAvailabilityInput!): ProviderAvailability! @aws_cognito_user_pools
  setProviderExceptions(input: SetExceptionsInput!): ProviderExceptions! @aws_cognito_user_pools
  
  # FAQs (Admin)
  createFAQ(input: CreateFAQInput!): FAQ! @aws_cognito_user_pools
  updateFAQ(input: UpdateFAQInput!): FAQ! @aws_cognito_user_pools
  deleteFAQ(faqId: ID!): FAQ! @aws_cognito_user_pools

  # Workflows (Admin)
  createWorkflow(input: CreateWorkflowInput!): Workflow! @aws_cognito_user_pools
  updateWorkflow(input: UpdateWorkflowInput!): Workflow! @aws_cognito_user_pools
  deleteWorkflow(workflowId: ID!): Workflow! @aws_cognito_user_pools

  # Documents (Knowledge Base)
  getUploadUrl(fileName: String!, contentType: String!): String! @aws_cognito_user_pools

  # Bookings
  createBooking(input: CreateBookingInput!): Booking! @aws_api_key @aws_cognito_user_pools
  confirmBooking(input: ConfirmBookingInput!): Booking! @aws_cognito_user_pools
  cancelBooking(input: CancelBookingInput!): Booking! @aws_cognito_user_pools
  markAsNoShow(bookingId: ID!): Booking! @aws_cognito_user_pools
  
  # User Management (Admin)
  inviteUser(input: InviteUserInput!): TenantUser! @aws_cognito_user_pools
  updateUserRole(input: UpdateUserRoleInput!): TenantUser! @aws_cognito_user_pools
  removeUser(userId: ID!): TenantUser! @aws_cognito_user_pools
  resetUserPassword(userId: ID!): Boolean! @aws_cognito_user_pools
  
  # API Keys
  createApiKey(name: String): ApiKey! @aws_cognito_user_pools
  revokeApiKey(apiKeyId: ID!): ApiKey! @aws_cognito_user_pools

  # Subscription Mutations
  subscribe(planId: String!, email: String, backUrl: String): SubscriptionResponse! @aws_cognito_user_pools
  downgrade(targetPlan: String!, subscriptionId: String!): DowngradeResponse! @aws_cognito_user_pools

  # Chat
  startConversation(input: StartConversationInput!): ChatResponse! @aws_api_key
  sendMessage(input: SendMessageInput!): ChatResponse! @aws_api_key
  confirmBookingFromConversation(input: ConfirmBookingFromConversationInput!): ChatResponse! @aws_api_key
}

input ExceptionRuleInput {
  date: String!
  timeRanges: [TimeRangeInput!]!
}

input SetExceptionsInput {
  providerId: ID!
  exceptions: [ExceptionRuleInput!]!
}

type ProviderExceptions @aws_cognito_user_pools {
  providerId: ID!
  exceptions: [ExceptionRule!]!
}

schema {
  query: Query
  mutation: Mutation
}
